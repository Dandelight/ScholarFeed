name: æ¯æ—¥è®ºæ–‡æ€»ç»“

env:
  UV_SYSTEM_PYTHON: 1
  AI_PROVIDER: claude
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  ANTHROPIC_MODEL: claude-sonnet-4-20250514
  ANTHROPIC_BASE_URL: https://api.openai-proxy.org/anthropic

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9:00 (UTC 1:00) æ‰§è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DD)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ä»Šæ—¥'
        required: false
        type: string
      category:
        description: 'arXivåˆ†ç±»'
        required: false
        default: 'cs.AI'
        type: choice
        options:
          - cs.AI
          - cs.CL
          - cs.LG
          - cs.CV

jobs:
  summarize:
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true

    - name: Install the project
      run: uv sync

    - name: æ‰§è¡Œè®ºæ–‡æ€»ç»“
      run: |
        # è®¾ç½®æ—¥æœŸ
        if [ -n "${{ github.event.inputs.date }}" ]; then
          TARGET_DATE="${{ github.event.inputs.date }}"
        else
          # ä½¿ç”¨æ˜¨å¤©çš„æ—¥æœŸï¼Œå› ä¸ºè®ºæ–‡é€šå¸¸åœ¨UTCæ—¶é—´å‘å¸ƒ
          TARGET_DATE=$(date -d "yesterday" +%Y-%m-%d)
        fi

        # è®¾ç½®åˆ†ç±»
        CATEGORY="${{ github.event.inputs.category || 'cs.AI' }}"

        uv run main.py $TARGET_DATE --category $CATEGORY --tee

        # æ›´æ–° README
        rm README.md
        cp reports/daily_report_${TARGET_DATE}.md README.md

    - name: é…ç½®Git
      run: |
        git config --local user.email "raymond@qingnan.tech"
        git config --local user.name "Raymond Guo"

    - name: æäº¤æ›´æ”¹
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°æ¯æ—¥è®ºæ–‡æ€»ç»“ $(date +%Y-%m-%d)"
          git push
          echo "æˆåŠŸæäº¤å¹¶æ¨é€æ›´æ”¹"
        fi

    - name: Minimize uv cache
      run: uv cache prune --ci
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: success()
      run: |
        echo "âœ… æ¯æ—¥è®ºæ–‡æ€»ç»“æ‰§è¡ŒæˆåŠŸï¼"
        echo "ğŸ“Š æŠ¥å‘Šå·²æ›´æ–°åˆ° reports/ ç›®å½•"
        echo "ğŸ“ README.md å·²è‡ªåŠ¨æ›´æ–°"
