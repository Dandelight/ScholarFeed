name: æ¯æ—¥è®ºæ–‡æ€»ç»“

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9:00 (UTC 1:00) æ‰§è¡Œ
    - cron: '0 1 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DD)ï¼Œç•™ç©ºåˆ™ä½¿ç”¨ä»Šæ—¥'
        required: false
        type: string
      category:
        description: 'arXivåˆ†ç±»'
        required: false
        default: 'cs.AI'
        type: choice
        options:
          - cs.AI
          - cs.CL
          - cs.LG
          - cs.CV

jobs:
  summarize:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: å®‰è£…ä¾èµ–
      run: go mod tidy

    - name: è®¾ç½®MySQLæ•°æ®åº“
      run: |
        sudo systemctl start mysql.service
        mysql -e "CREATE DATABASE IF NOT EXISTS arxiv_db;" -uroot -proot
        mysql -e "CREATE USER IF NOT EXISTS 'arxiv'@'localhost' IDENTIFIED BY 'arxiv123';" -uroot -proot
        mysql -e "GRANT ALL PRIVILEGES ON arxiv_db.* TO 'arxiv'@'localhost';" -uroot -proot
        mysql -e "FLUSH PRIVILEGES;" -uroot -proot

    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      run: |
        cat > .env << EOF
        # æ•°æ®åº“é…ç½®
        DB_HOST=localhost
        DB_PORT=3306
        DB_USER=arxiv
        DB_PASSWORD=arxiv123
        DB_NAME=arxiv_db
        
        # AIé…ç½®
        AI_PROVIDER=claude
        ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
        ANTHROPIC_MODEL=claude-sonnet-4-20250514
        ANTHROPIC_BASE_URL=https://api.openai-proxy.org/anthropic
        
        # arXivé…ç½®
        ARXIV_CATEGORY=cs.AI
        ARXIV_MAX_RESULTS=100
        ARXIV_DELAY_SECONDS=3.0
        ARXIV_NUM_RETRIES=3
        
        # æœåŠ¡å™¨é…ç½®
        PORT=8080
        GIN_MODE=release
        EOF

    - name: æ„å»ºåº”ç”¨
      run: go build -o arxiv-server cmd/server/main.go

    - name: å¯åŠ¨æœåŠ¡å™¨ (åå°)
      run: |
        ./arxiv-server &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        sleep 10  # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨

    - name: å¥åº·æ£€æŸ¥
      run: |
        curl -f http://localhost:8080/health || (echo "å¥åº·æ£€æŸ¥å¤±è´¥" && exit 1)

    - name: æ‰§è¡Œè®ºæ–‡æ€»ç»“
      run: |
        # è®¾ç½®æ—¥æœŸ
        if [ -n "${{ github.event.inputs.date }}" ]; then
          TARGET_DATE="${{ github.event.inputs.date }}"
        else
          # ä½¿ç”¨æ˜¨å¤©çš„æ—¥æœŸï¼Œå› ä¸ºè®ºæ–‡é€šå¸¸åœ¨UTCæ—¶é—´å‘å¸ƒ
          TARGET_DATE=$(date -d "yesterday" +%Y-%m-%d)
        fi
        
        # è®¾ç½®åˆ†ç±»
        CATEGORY="${{ github.event.inputs.category || 'cs.AI' }}"
        
        echo "å¼€å§‹æ€»ç»“ $TARGET_DATE çš„ $CATEGORY åˆ†ç±»è®ºæ–‡..."
        
        # è°ƒç”¨API
        RESPONSE=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"date\":\"$TARGET_DATE\",\"category\":\"$CATEGORY\"}" \
          http://localhost:8080/api/summarize)
        
        echo "APIå“åº”: $RESPONSE"
        
        # æ£€æŸ¥APIè°ƒç”¨æ˜¯å¦æˆåŠŸ
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "âœ… è®ºæ–‡æ€»ç»“æˆåŠŸå®Œæˆ"
        else
          echo "âŒ è®ºæ–‡æ€»ç»“å¤±è´¥"
          echo "å“åº”å†…å®¹: $RESPONSE"
          exit 1
        fi
        
        echo "è®ºæ–‡æ€»ç»“å®Œæˆ"

    - name: åœæ­¢æœåŠ¡å™¨
      if: always()
      run: |
        if [ -n "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶..."
        ls -la reports/ || echo "æŠ¥å‘Šç›®å½•ä¸å­˜åœ¨"
        ls -la README.md || echo "README.mdä¸å­˜åœ¨"

    - name: é…ç½®Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: æäº¤æ›´æ”¹
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
        else
          git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°æ¯æ—¥è®ºæ–‡æ€»ç»“ $(date +%Y-%m-%d)"
          git push
          echo "æˆåŠŸæäº¤å¹¶æ¨é€æ›´æ”¹"
        fi

    - name: åˆ›å»ºæ€»ç»“å®Œæˆçš„Issue (å¦‚æœ‰é”™è¯¯)
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = `æ¯æ—¥è®ºæ–‡æ€»ç»“å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## æ¯æ—¥è®ºæ–‡æ€»ç»“æ‰§è¡Œå¤±è´¥
          
          **æ‰§è¡Œæ—¶é—´**: ${new Date().toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'})}
          **å·¥ä½œæµ**: ${{ github.workflow }}
          **è¿è¡ŒID**: ${{ github.run_id }}
          
          è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥äº†è§£å¤±è´¥åŸå› ã€‚
          
          [æŸ¥çœ‹è¿è¡Œè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'automated']
          });

    - name: å‘é€æˆåŠŸé€šçŸ¥ (å¯é€‰)
      if: success()
      run: |
        echo "âœ… æ¯æ—¥è®ºæ–‡æ€»ç»“æ‰§è¡ŒæˆåŠŸï¼"
        echo "ğŸ“Š æŠ¥å‘Šå·²æ›´æ–°åˆ° reports/ ç›®å½•"
        echo "ğŸ“ README.md å·²è‡ªåŠ¨æ›´æ–°"